# ----------------------------------------------------------------------------------
# THIS CODE AND INFORMATION ARE PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND, 
# EITHER EXPRESSED OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE IMPLIED WARRANTIES 
# OF MERCHANTABILITY AND/OR FITNESS FOR A PARTICULAR PURPOSE.
# ----------------------------------------------------------------------------------

parameters:
  - name: description
    type: string
  - name: scope
    type: string
    values:
      - management-groups
      - subscriptions
  - name: bicepFile
    type: string
  - name: armFile
    type: string
  - name: workingDir
    type: string

steps:

- task: Bash@3
  displayName: ${{ parameters.description }} - Install Bicep
  inputs:
    targetType: 'inline'
    script: |
      $(var-bashPreInjectScript)

      echo "Installing bicep..."
      curl -Lo bicep https://github.com/Azure/bicep/releases/latest/download/bicep-linux-x64
      chmod +x bicep
      ./bicep --version

      $(var-bashPostInjectScript)
    workingDirectory: '${{ parameters.workingDir }}'

- task: Bash@3
  displayName: ${{ parameters.description }} - Transpile Bicep
  inputs:
    targetType: 'inline'
    script: |
      $(var-bashPreInjectScript)

      echo "Transpiling bicep file..."

      rm -f ${{ parameters.armFile }}
      ./bicep build ${{ parameters.bicepFile }} --outfile ${{ parameters.armFile }}

      # Required until https://github.com/Azure/bicep/issues/1691 is fixed
      chmod u+x $(System.DefaultWorkingDirectory)/pipelines/scripts/add-scope-${{ parameters.scope }}.sh
      $(System.DefaultWorkingDirectory)/pipelines/scripts/add-scope-${{ parameters.scope }}.sh ${{ parameters.armFile }}

      echo "Contents of transpiled (Bicep to ARM) template:"
      echo "----------------------------------------------------------------------------------"
      cat ${{ parameters.armFile }}
      echo "----------------------------------------------------------------------------------"

      $(var-bashPostInjectScript)
    workingDirectory: '${{ parameters.workingDir }}'
