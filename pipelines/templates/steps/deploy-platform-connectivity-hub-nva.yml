# ----------------------------------------------------------------------------------
# THIS CODE AND INFORMATION ARE PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND, 
# EITHER EXPRESSED OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE IMPLIED WARRANTIES 
# OF MERCHANTABILITY AND/OR FITNESS FOR A PARTICULAR PURPOSE.
# ----------------------------------------------------------------------------------

parameters:
  - name: description
    type: string
  - name: moveTemplate
    type: string
  - name: templateFile
    type: string
  - name: workingDir
    type: string
  - name: deployOperation
    type: string
    default: create
    values:
      - create
      - what-if

steps:

- task: AzureCLI@2
  displayName: ${{ parameters.description }} - Move Subscription
  inputs:
    azureSubscription: $(serviceConnection)
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
      $(var-bashPreInjectScript)

      az bicep upgrade

      echo "Deploying ${{ parameters.moveTemplate }} using ${{ parameters.deployOperation}} operation..."

      az deployment mg ${{ parameters.deployOperation }} \
        --location $(deploymentRegion) \
        --management-group-id $(var-hubnetwork-managementGroupId) \
        --template-file ${{ parameters.moveTemplate }} \
        --parameters \
            managementGroupId='$(var-hubnetwork-managementGroupId)' \
            subscriptionId='$(var-hubnetwork-subscriptionId)'

      $(var-bashPostInjectScript)
    workingDirectory: '${{ parameters.workingDir }}/utils/mg-move'

- task: AzureCLI@2
  displayName: ${{ parameters.description }} - Deploy
  inputs:
    azureSubscription: $(serviceConnection)
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
      $(var-bashPreInjectScript)

      echo "Deploying ${{ parameters.templateFile }} using ${{ parameters.deployOperation}} operation..."
      
      az deployment sub ${{ parameters.deployOperation }} \
      --location $(deploymentRegion) \
      --subscription $(var-hubnetwork-subscriptionId) \
      --template-file ${{ parameters.templateFile }} \
      --parameters \
          logAnalyticsWorkspaceResourceId='$(var-logging-logAnalyticsWorkspaceResourceId)' \
          subscriptionOwnerGroupObjectIds='$(var-hubnetwork-subscriptionOwnerGroupObjectIds)' \
          subscriptionContributorGroupObjectIds='$(var-hubnetwork-subscriptionContributorGroupObjectIds)' \
          subscriptionReaderGroupObjectIds='$(var-hubnetwork-subscriptionReaderGroupObjectIds)' \
          securityContactEmail='$(var-hubnetwork-securityContactEmail)' \
          securityContactPhone='$(var-hubnetwork-securityContactPhone)' \
          createBudget='$(var-hubnetwork-createBudget)' \
          budgetName='$(var-hubnetwork-budgetName)' \
          budgetAmount='$(var-hubnetwork-budgetAmount)' \
          budgetTimeGrain='$(var-hubnetwork-budgetTimeGrain)' \
          budgetStartDate='$(var-hubnetwork-budgetStartDate)' \
          budgetNotificationEmailAddress='$(var-hubnetwork-budgetNotificationEmailAddress)' \
          tagISSO='$(var-hubnetwork-tagISSO)' \
          tagClientOrganization='$(var-hubnetwork-tagClientOrganization)' \
          tagCostCenter='$(var-hubnetwork-tagCostCenter)' \
          tagDataSensitivity='$(var-hubnetwork-tagDataSensitivity)' \
          tagProjectContact='$(var-hubnetwork-tagProjectContact)' \
          tagProjectName='$(var-hubnetwork-tagProjectName)' \
          tagTechnicalContact='$(var-hubnetwork-tagTechnicalContact)' \
          deployDdosStandard='$(var-hubnetwork-deployDdosStandard)' \
          rgDdosName='$(var-hubnetwork-rgDdosName)' \
          ddosPlanName='$(var-hubnetwork-ddosPlanName)' \
          Hub_IPrange='$(var-hubnetwork-Hub_IPrange)' \
          Hub_CGNATrange='$(var-hubnetwork-Hub_CGNATrange)' \
          Hub_BastionRange='$(var-hubnetwork-Hub_BastionRange)' \
          Subnet_Public='$(var-hubnetwork-Subnet_Public)' \
          Subnet_EAN='$(var-hubnetwork-Subnet_EAN)' \
          Subnet_MRZInt='$(var-hubnetwork-Subnet_MRZInt)' \
          Subnet_PrdInt='$(var-hubnetwork-Subnet_PrdInt)' \
          Subnet_DevInt='$(var-hubnetwork-Subnet_DevInt)' \
          Subnet_HA='$(var-hubnetwork-Subnet_HA)' \
          Subnet_PAZ='$(var-hubnetwork-Subnet_PAZ)' \
          Subnet_Bastion='$(var-hubnetwork-Subnet_Bastion)' \
          Subnet_Public_name='$(var-hubnetwork-Subnet_Public_name)' \
          Subnet_EAN_name='$(var-hubnetwork-Subnet_EAN_name)' \
          Subnet_MRZInt_name='$(var-hubnetwork-Subnet_MRZInt_name)' \
          Subnet_PrdInt_name='$(var-hubnetwork-Subnet_PrdInt_name)' \
          Subnet_DevInt_name='$(var-hubnetwork-Subnet_DevInt_name)' \
          Subnet_HA_name='$(var-hubnetwork-Subnet_HA_name)' \
          Subnet_PAZ_name='$(var-hubnetwork-Subnet_PAZ_name)' \
          FW_VM_sku_prod='$(var-hubnetwork-FW_VM_sku_prod)' \
          FW_VM_sku_dev='$(var-hubnetwork-FW_VM_sku_dev)' \
          useFortigateFW='$(var-hubnetwork-useFortigateFW)' \
          FW_VIP_ProdFWs_Public='$(var-hubnetwork-FW_VIP_ProdFWs_Public)' \
          FW_ProdFW1_Public='$(var-hubnetwork-FW_ProdFW1_Public)' \
          FW_ProdFW2_Public='$(var-hubnetwork-FW_ProdFW2_Public)' \
          FW_VIP_DevFWs_Public='$(var-hubnetwork-FW_VIP_DevFWs_Public)' \
          FW_DevFW1_Public='$(var-hubnetwork-FW_DevFW1_Public)' \
          FW_DevFW2_Public='$(var-hubnetwork-FW_DevFW2_Public)' \
          FW_VIP_ProdFWs_MRZInt='$(var-hubnetwork-FW_VIP_ProdFWs_MRZInt)' \
          FW_ProdFW1_MRZInt='$(var-hubnetwork-FW_ProdFW1_MRZInt)' \
          FW_ProdFW2_MRZInt='$(var-hubnetwork-FW_ProdFW2_MRZInt)' \
          FW_VIP_DevFWs_MRZInt='$(var-hubnetwork-FW_VIP_DevFWs_MRZInt)' \
          FW_DevFW1_MRZInt='$(var-hubnetwork-FW_DevFW1_MRZInt)' \
          FW_DevFW2_MRZInt='$(var-hubnetwork-FW_DevFW2_MRZInt)' \
          FW_VIP_ProdFWs_PrdInt='$(var-hubnetwork-FW_VIP_ProdFWs_PrdInt)' \
          FW_ProdFW1_PrdInt='$(var-hubnetwork-FW_ProdFW1_PrdInt)' \
          FW_ProdFW2_PrdInt='$(var-hubnetwork-FW_ProdFW2_PrdInt)' \
          FW_VIP_DevFWs_DevInt='$(var-hubnetwork-FW_VIP_DevFWs_DevInt)' \
          FW_DevFW1_DevInt='$(var-hubnetwork-FW_DevFW1_DevInt)' \
          FW_DevFW2_DevInt='$(var-hubnetwork-FW_DevFW2_DevInt)' \
          FW_ProdFW1_HA='$(var-hubnetwork-FW_ProdFW1_HA)' \
          FW_ProdFW2_HA='$(var-hubnetwork-FW_ProdFW2_HA)' \
          FW_DevFW1_HA='$(var-hubnetwork-FW_DevFW1_HA)' \
          FW_DevFW2_HA='$(var-hubnetwork-FW_DevFW2_HA)' \
          MRZ_IPrange='$(var-hubnetwork-MRZ_IPrange)' \
          Subnet_MAZ='$(var-hubnetwork-Subnet_MAZ)' \
          Subnet_INF='$(var-hubnetwork-Subnet_INF)' \
          Subnet_SEC='$(var-hubnetwork-Subnet_SEC)' \
          Subnet_LOG='$(var-hubnetwork-Subnet_LOG)' \
          Subnet_MGMT='$(var-hubnetwork-Subnet_MGMT)' \
          Subnet_MAZ_name='$(var-hubnetwork-Subnet_MAZ_name)' \
          Subnet_INF_name='$(var-hubnetwork-Subnet_INF_name)' \
          Subnet_SEC_name='$(var-hubnetwork-Subnet_SEC_name)' \
          Subnet_LOG_name='$(var-hubnetwork-Subnet_LOG_name)' \
          Subnet_MGMT_name='$(var-hubnetwork-Subnet_MGMT_name)' \
          RG_Hub_name='$(var-hubnetwork-RG_Hub_name)' \
          RG_Mrz_name='$(var-hubnetwork-RG_Mrz_name)' \
          RG_Paz_name='$(var-hubnetwork-RG_Paz_name)' \
          VNET_Hub_name='$(var-hubnetwork-VNET_Hub_name)' \
          VNET_Mrz_name='$(var-hubnetwork-VNET_Mrz_name)' \
          Bastion_name='$(var-hubnetwork-Bastion_name)' \
          PrdFWILB_name='$(var-hubnetwork-PrdFWILB_name)' \
          DevFWILB_name='$(var-hubnetwork-DevFWILB_name)' \
          FW_ProdFW1_name='$(var-hubnetwork-FW_ProdFW1_name)' \
          FW_ProdFW2_name='$(var-hubnetwork-FW_ProdFW2_name)' \
          FW_DevFW1_name='$(var-hubnetwork-FW_DevFW1_name)' \
          FW_DevFW2_name='$(var-hubnetwork-FW_DevFW2_name)' \
          FW_ProdFW_username='$(var-hubnetwork-FW_ProdFW_username)' \
          FW_ProdFW_temppassword='$(var-hubnetwork-FW_ProdFW_temppassword)'
          
      $(var-bashPostInjectScript)
    workingDirectory: '${{ parameters.workingDir }}/lz-platform-connectivity-hub-nva'
